<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jadwal Kerja Shift Premium dengan Perhitungan Biasa</title>
<style>
/* ===== VARIABLES & BASE STYLES ===== */
:root {
  /* Default Theme */
  --bg: #f2f4f7;
  --card: #fff;
  --text: #1f2937;
  --muted: #6b7280;
  --pagi: #fde68a;
  --sore: #bae6fd;
  --malam: #d1d5db;
  --libur: #f9a8d4;
  --today: #2563eb22;
  --select: #000;
  --accent: #3b82f6;
  --accent-gradient: linear-gradient(to right, #3b82f6, #8b5cf6);
  --shadow: 0 10px 25px rgba(0,0,0,.08);
  --border: #cbd5e1;
  --header-bg: transparent;
  --badge-text: #000;
  --theme-bg: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="white"/></svg>');
}

/* ===== THEME DEFINITIONS ===== */
body.theme-lebaran {
  --bg: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%);
  --card: #ffffff;
  --text: #1a202c;
  --muted: #718096;
  --pagi: linear-gradient(135deg, #f6e05e, #d69e2e);
  --sore: linear-gradient(135deg, #68d391, #38a169);
  --malam: linear-gradient(135deg, #90cdf4, #4299e1);
  --libur: linear-gradient(135deg, #fbb6ce, #ed64a6);
  --today: rgba(104, 211, 145, 0.2);
  --accent: #38a169;
  --accent-gradient: linear-gradient(to right, #38a169, #2f855a);
  --shadow: 0 10px 30px rgba(56, 161, 105, 0.15);
  --border: #c6f6d5;
  --header-bg: linear-gradient(135deg, #38a169, #2f855a);
  --badge-text: #fff;
  --theme-bg: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%2338a169" opacity="0.1"/><path d="M20,20 Q50,5 80,20 T140,20" stroke="%2338a169" stroke-width="2" fill="none" opacity="0.3"/></svg>');
}

body.theme-natal {
  --bg: linear-gradient(135deg, #fed7d7 0%, #fff5f5 100%);
  --card: #ffffff;
  --text: #2d3748;
  --muted: #718096;
  --pagi: linear-gradient(135deg, #fc8181, #e53e3e);
  --sore: linear-gradient(135deg, #9ae6b4, #48bb78);
  --malam: linear-gradient(135deg, #d69e2e, #b7791f);
  --libur: linear-gradient(135deg, #fbb6ce, #ed64a6);
  --today: rgba(229, 62, 62, 0.15);
  --accent: #e53e3e;
  --accent-gradient: linear-gradient(to right, #e53e3e, #c53030);
  --shadow: 0 10px 30px rgba(229, 62, 62, 0.15);
  --border: #fed7d7;
  --header-bg: linear-gradient(135deg, #e53e3e, #c53030);
  --badge-text: #fff;
  --theme-bg: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23e53e3e" opacity="0.1"/><polygon points="50,10 63,38 93,38 68,55 75,85 50,68 25,85 32,55 7,38 37,38" fill="%23e53e3e" opacity="0.3"/></svg>');
}

body.theme-halloween {
  --bg: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
  --card: #2d3748;
  --text: #e2e8f0;
  --muted: #a0aec0;
  --pagi: linear-gradient(135deg, #ed8936, #dd6b20);
  --sore: linear-gradient(135deg, #805ad5, #6b46c1);
  --malam: linear-gradient(135deg, #000000, #4a5568);
  --libur: linear-gradient(135deg, #f56565, #e53e3e);
  --today: rgba(237, 137, 54, 0.25);
  --accent: #ed8936;
  --accent-gradient: linear-gradient(to right, #ed8936, #dd6b20);
  --shadow: 0 10px 30px rgba(237, 137, 54, 0.2);
  --border: #4a5568;
  --header-bg: linear-gradient(135deg, #ed8936, #dd6b20);
  --badge-text: #fff;
  --theme-bg: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23ed8936" opacity="0.1"/><path d="M30,70 Q50,30 70,70 Q60,90 40,90 Q30,80 30,70" fill="%23ed8936" opacity="0.3"/></svg>');
}

body.theme-luar-angkasa {
  --bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  --card: #1e293b;
  --text: #e2e8f0;
  --muted: #94a3b8;
  --pagi: linear-gradient(135deg, #60a5fa, #3b82f6);
  --sore: linear-gradient(135deg, #8b5cf6, #7c3aed);
  --malam: linear-gradient(135deg, #1e40af, #1e3a8a);
  --libur: linear-gradient(135deg, #ec4899, #db2777);
  --today: rgba(96, 165, 250, 0.25);
  --accent: #60a5fa;
  --accent-gradient: linear-gradient(to right, #60a5fa, #8b5cf6);
  --shadow: 0 10px 30px rgba(96, 165, 250, 0.2);
  --border: #334155;
  --header-bg: linear-gradient(135deg, #1e40af, #1e3a8a);
  --badge-text: #fff;
  --theme-bg: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%231e40af" opacity="0.1"/><circle cx="20" cy="20" r="2" fill="white" opacity="0.8"/><circle cx="60" cy="40" r="1.5" fill="white" opacity="0.8"/><circle cx="80" cy="70" r="1" fill="white" opacity="0.8"/><circle cx="40" cy="80" r="1.5" fill="white" opacity="0.8"/></svg>');
}

body.theme-musim-salju {
  --bg: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
  --card: #ffffff;
  --text: #1e3a8a;
  --muted: #475569;
  --pagi: linear-gradient(135deg, #93c5fd, #60a5fa);
  --sore: linear-gradient(135deg, #c7d2fe, #a5b4fc);
  --malam: linear-gradient(135deg, #dbeafe, #bfdbfe);
  --libur: linear-gradient(135deg, #fecdd3, #fda4af);
  --today: rgba(96, 165, 250, 0.2);
  --accent: #3b82f6;
  --accent-gradient: linear-gradient(to right, #3b82f6, #1d4ed8);
  --shadow: 0 10px 30px rgba(59, 130, 246, 0.15);
  --border: #bfdbfe;
  --header-bg: linear-gradient(135deg, #3b82f6, #1d4ed8);
  --badge-text: #fff;
  --theme-bg: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%233b82f6" opacity="0.1"/><path d="M20,40 Q30,20 50,40 Q70,20 80,40 Q70,60 50,40 Q30,60 20,40" fill="%233b82f6" opacity="0.3"/></svg>');
}

body.theme-dark {
  --bg: #0f172a;
  --card: #1e293b;
  --text: #e5e7eb;
  --muted: #9ca3af;
  --pagi: #92400e;
  --sore: #075985;
  --malam: #374151;
  --libur: #065f46;
  --today: #38bdf822;
  --select: #fff;
  --accent: #60a5fa;
  --accent-gradient: linear-gradient(to right, #60a5fa, #a78bfa);
  --shadow: 0 10px 25px rgba(0,0,0,0.3);
  --border: #374151;
  --header-bg: transparent;
  --badge-text: #fff;
  --theme-bg: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%230f172a"/><circle cx="50" cy="50" r="20" fill="%2360a5fa" opacity="0.1"/></svg>');
}

/* ===== BASE STYLES ===== */
body {
  margin: 0;
  font-family: system-ui, -apple-system, sans-serif;
  background: var(--bg);
  background-image: var(--theme-bg);
  color: var(--text);
  transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  min-height: 100vh;
}

/* Fullscreen mode */
body:fullscreen {
  background: var(--bg);
  padding: 20px;
}

body:fullscreen .container {
  max-width: 95%;
  margin: auto;
}

.container {
  max-width: 920px;
  margin: auto;
  padding: 20px;
}

/* ===== HEADER STYLES ===== */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding: 15px 20px;
  background: var(--header-bg);
  border-radius: 16px;
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
}

header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--accent-gradient);
}

.header-left h1 {
  font-size: 24px;
  margin: 0;
  background: linear-gradient(135deg, var(--accent), var(--text));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-weight: 800;
  color: #fff !important;
}

.sub {
  color: var(--muted);
  font-size: 14px;
  margin-top: 4px;
}

.header-right {
  display: flex;
  gap: 10px;
  align-items: center;
}

/* ===== CARD STYLES ===== */
.card {
  background: var(--card);
  border-radius: 20px;
  box-shadow: var(--shadow);
  padding: 25px;
  border: 1px solid var(--border);
  position: relative;
  overflow: hidden;
}

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--accent-gradient);
}

/* ===== CONTROLS ===== */
.controls {
  display: flex;
  gap: 5px;
  flex-wrap: wrap;
  margin-bottom: 25px;
  justify-content: center;
  align-items: center;
  padding: 5px;
  background: rgba(0,0,0,0.02);
  border-radius: 12px;
  border: 1px solid var(--border);
}

body.theme-dark .controls {
  background: rgba(255,255,255,0.02);
}

input, button, select {
  padding: 10px 16px;
  border-radius: 12px;
  border: 2px solid var(--border);
  background: var(--card);
  color: var(--text);
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  font-size: 14px;
}

input:hover, button:hover, select:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

button.primary {
  background: var(--accent-gradient);
  color: white;
  border: none;
  font-weight: 700;
}

button.primary:hover {
  background: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(var(--accent-rgb, 59,130,246), 0.3);
}

/* ===== THEME SELECTOR ===== */
.theme-selector {
  position: relative;
  min-width: 160px;
}

.theme-selector select {
  width: 100%;
  appearance: none;
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 16px;
  padding-right: 40px;
}

/* ===== TABLE STYLES ===== */
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
  table-layout: fixed;
  border-radius: 12px;
  overflow: hidden;
}

th, td {
  padding: 12px 8px;
  text-align: center;
  border-bottom: 1px solid var(--border);
}

th {
  color: var(--muted);
  font-weight: 700;
  text-transform: uppercase;
  font-size: 12px;
  letter-spacing: 0.5px;
  background: rgba(0,0,0,0.02);
}

body.theme-dark th {
  background: rgba(255,255,255,0.02);
}

tr.today {
  background: var(--today);
  position: relative;
}

/* ===== SELECTED ROW STYLES ===== */
tr.selected {
  position: relative;
  background: linear-gradient(90deg, transparent 0%, rgba(var(--accent-rgb, 59,130,246), 0.15) 50%, transparent 100%);
  box-shadow: 
    inset 0 2px 12px rgba(var(--accent-rgb, 59,130,246), 0.1),
    inset 0 -2px 12px rgba(var(--accent-rgb, 59,130,246), 0.1);
}

tr.selected td {
  position: relative;
}

tr.selected td:first-child::before {
  content: '';
  position: absolute;
  left: -2px;
  top: 50%;
  transform: translateY(-50%);
  width: 4px;
  height: 70%;
  background: var(--accent-gradient);
  border-radius: 2px;
  box-shadow: 0 0 12px var(--accent);
}

tr.selected .badge {
  transform: scale(1.08);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

tr:not(.selected):hover {
  background: rgba(0, 0, 0, 0.04);
  transition: background 0.2s ease;
  cursor: pointer;
}

body.theme-dark tr:not(.selected):hover {
  background: rgba(255, 255, 255, 0.06);
}

/* ===== BADGE STYLES ===== */
.badge {
  display: inline-block;
  width: 75px;
  text-align: center;
  padding: 8px 0;
  border-radius: 20px;
  font-weight: 800;
  font-size: 12px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  color: var(--badge-text);
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  letter-spacing: 0.3px;
}

.pagi {
  background: var(--pagi);
  box-shadow: 0 4px 12px rgba(253, 230, 138, 0.4);
}

.sore {
  background: var(--sore);
  box-shadow: 0 4px 12px rgba(186, 230, 253, 0.4);
}

.malam {
  background: var(--malam);
  box-shadow: 0 4px 12px rgba(209, 213, 219, 0.4);
}

.libur {
  background: var(--libur);
  box-shadow: 0 4px 12px rgba(249, 168, 212, 0.4);
}

/* ===== DATE CELL STYLES ===== */
table td:first-child {
  border-right: 3px solid var(--accent);
  padding-right: 15px;
  font-weight: 700;
  text-align: left;
  min-width: 90px;
}

.sunday {
  color: #ef4444 !important;
  font-weight: 800;
}

.holiday-note {
  display: block;
  font-size: 11px;
  color: #ef4444;
  margin-top: 4px;
  font-style: italic;
  font-weight: 600;
}

/* ===== MODAL STYLES ===== */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(5px);
}

.modal-content {
  background: var(--card);
  padding: 30px;
  border-radius: 20px;
  min-width: 300px;
  max-width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  border: 1px solid var(--border);
  box-shadow: 0 25px 50px rgba(0,0,0,0.3);
  position: relative;
}

.modal-content::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--accent-gradient);
  border-radius: 20px 20px 0 0;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
  .container {
    padding: 12px;
  }
  
  header {
    flex-direction: column;
    gap: 15px;
    text-align: center;
    padding: 20px;
  }
  
  .header-right {
    width: 100%;
    justify-content: center;
  }
  
  .controls {
    gap: 8px;
  }
  
  .card {
    padding: 16px;
  }
  
  table {
    font-size: 12px;
  }
  
  th, td {
    padding: 8px 4px;
  }
  
  .badge {
    width: 60px;
    padding: 6px 0;
    font-size: 11px;
  }
  
  table td:first-child {
    min-width: 70px;
    padding-right: 8px;
  }
}

/* ===== ANIMATIONS ===== */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes glow {
  0%, 100% { box-shadow: 0 0 20px rgba(var(--accent-rgb, 59,130,246), 0.3); }
  50% { box-shadow: 0 0 30px rgba(var(--accent-rgb, 59,130,246), 0.5); }
}

.card {
  animation: fadeIn 0.6s ease-out;
}

.primary {
  animation: glow 2s ease-in-out infinite;
}

/* ===== THEME PREVIEW IN SELECT ===== */
.theme-selector option[value="default"] {
  background: linear-gradient(135deg, #f2f4f7, #fff);
  color: #1f2937;
}

.theme-selector option[value="lebaran"] {
  background: linear-gradient(135deg, #38a169, #2f855a);
  color: white;
}

.theme-selector option[value="natal"] {
  background: linear-gradient(135deg, #e53e3e, #c53030);
  color: white;
}

.theme-selector option[value="halloween"] {
  background: linear-gradient(135deg, #ed8936, #dd6b20);
  color: white;
}

.theme-selector option[value="luar-angkasa"] {
  background: linear-gradient(135deg, #1e40af, #1e3a8a);
  color: white;
}

.theme-selector option[value="musim-salju"] {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
}

.theme-selector option[value="dark"] {
  background: linear-gradient(135deg, #1e293b, #0f172a);
  color: white;
}
.calendar-icon {
  -webkit-text-fill-color: initial;
  background: none;
  color: var(--muted);
  margin-right: 6px;
}
header .sub {
  color: white;
  opacity: 0.85;
  text-shadow: 0 1px 3px rgba(0,0,0,0.25);
  font-weight: 600;
}
</style>
</head>
<body>
<div class="container">
<header>
  <div class="header-left">
    <h1>
  <span class="calendar-icon">üìÖ</span>
  Jadwal Kerja Shift 4 Grup
   </h1>
    <div class="sub" id="monthLabel"></div>
  </div>
  <div class="header-right">
    <!-- Theme Selector -->
    <div class="theme-selector">
      <select id="themeSelect" title="Pilih tema">
        <option value="default">üé® Default</option>
        <option value="lebaran">üåø Lebaran</option>
        <option value="natal">üéÑ Natal</option>
        <option value="halloween">üéÉ Halloween</option>
        <option value="luar-angkasa">üöÄ Luar Angkasa</option>
        <option value="musim-salju">‚ùÑÔ∏è Musim Salju</option>
        <option value="dark">üåô Dark Mode</option>
      </select>
    </div>
    
    <button id="fullscreenToggle" aria-label="Toggle fullscreen" title="Fullscreen">‚õ∂</button>    
    <button id="darkToggle" aria-label="Toggle dark mode" title="Toggle Dark Mode">üåô</button>
  </div>
</header>

<div class="card">
<div class="controls">
  <button id="prev" title="Bulan sebelumnya (‚Üê)">‚¨ÖÔ∏è Prev</button>
  <input type="month" id="monthPicker" title="Pilih bulan">
  <button id="next" title="Bulan berikutnya (‚Üí)">Next ‚û°Ô∏è</button>
  <button onclick="openShiftModal()" title="Atur shift hari ini">‚öôÔ∏è Custom Shift</button>
  <button class="primary" onclick="exportToPDF()" title="Cetak jadwal">üñ®Ô∏è Cetak / PDF</button>
</div>

<table>
<thead>
<tr>
  <th>Tanggal</th>
  <th>Grup A</th>
  <th>Grup B</th>
  <th>Grup C</th>
  <th>Grup D</th>
</tr>
</thead>
<tbody id="tableBody">
  <!-- Jadwal akan diisi oleh JavaScript -->
</tbody>
</table>
</div>
</div>

<!-- Modal Setting Shift -->
<div id="shiftModal" class="modal">
<div class="modal-content">
  <h3 style="margin:0 0 15px 0;display:flex;align-items:center;gap:10px;">‚öôÔ∏è Pengaturan Shift</h3>
  
  <div style="background:var(--today);padding:12px 16px;border-radius:10px;margin-bottom:20px;font-size:14px;" id="shiftInfo">
    <strong>üìÖ Atur shift untuk:</strong> <span id="todayDateLabel">Hari ini</span>
  </div>
  
  <!-- Shift Inputs untuk sistem biasa -->
  <div style="display:grid;gap:15px;margin-top:10px;">
    <label style="display:flex;justify-content:space-between;align-items:center;">
      <span style="font-weight:700;">üë• Grup A</span>
      <select id="shiftA" style="padding:8px 12px;border-radius:10px;background:var(--card);color:var(--text);min-width:150px;border:2px solid var(--border);">
        <option value="0">Pagi 1</option>
        <option value="1">Pagi 1</option>
        <option value="2">Sore 1</option>
        <option value="3">Sore 2</option>
        <option value="4">Malam 1</option>
        <option value="5">Malam 2</option>
        <option value="6">Libur 1</option>
        <option value="7">Libur 2</option>
      </select>
    </label>
    <label style="display:flex;justify-content:space-between;align-items:center;">
      <span style="font-weight:700;">üë• Grup B</span>
      <select id="shiftB" style="padding:8px 12px;border-radius:10px;background:var(--card);color:var(--text);min-width:150px;border:2px solid var(--border);">
        <option value="0">Pagi 1</option>
        <option value="1">Pagi 2</option>
        <option value="2">Sore 1</option>
        <option value="3">Sore 2</option>
        <option value="4">Malam 1</option>
        <option value="5">Malam 2</option>
        <option value="6">Libur 1</option>
        <option value="7">Libur 2</option>
      </select>
    </label>
    <label style="display:flex;justify-content:space-between;align-items:center;">
      <span style="font-weight:700;">üë• Grup C</span>
      <select id="shiftC" style="padding:8px 12px;border-radius:10px;background:var(--card);color:var(--text);min-width:150px;border:2px solid var(--border);">
        <option value="0">Pagi 1</option>
        <option value="1">Pagi 2</option>
        <option value="2">Sore 1</option>
        <option value="3">Sore 2</option>
        <option value="4">Malam 1</option>
        <option value="5">Malam 2</option>
        <option value="6">Libur 1</option>
        <option value="7">Libur 2</option>
      </select>
    </label>
    <label style="display:flex;justify-content:space-between;align-items:center;">
      <span style="font-weight:700;">üë• Grup D</span>
      <select id="shiftD" style="padding:8px 12px;border-radius:10px;background:var(--card);color:var(--text);min-width:150px;border:2px solid var(--border);">
        <option value="0">Pagi 1</option>
        <option value="1">Pagi 2</option>
        <option value="2">Sore 1</option>
        <option value="3">Sore 2</option>
        <option value="4">Malam 1</option>
        <option value="5">Malam 2</option>
        <option value="6">Libur 1</option>
        <option value="7">Libur 2</option>
      </select>
    </label>
  </div>
  
  <div style="margin-top:25px;padding-top:20px;border-top:2px solid var(--border);">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <button onclick="closeShiftModal()">‚ùå Batal</button>
      <div style="display:flex;gap:10px;">
        <button onclick="resetShiftToDefault()" style="background:transparent;border:2px solid var(--border);">üîÑ Reset ke Default</button>
        <button class="primary" onclick="saveShift()">üíæ Simpan Setting</button>
      </div>
    </div>
  </div>
</div>
</div>

<script>
// ===== KONSTANTA & VARIABEL =====
const START_DATE = new Date(2025, 11, 22); // 22 Desember 2025
const SHIFT_CYCLE = ["Pagi", "Pagi", "Sore", "Sore", "Malam", "Malam", "Libur", "Libur"];
const OFFSETS = { A: 6, B: 4, C: 2, D: 0 }; // Offset untuk 22 Des 2025

// ===== VARIABEL GLOBAL =====
let currentYear, currentMonth;
let HOLIDAYS = {};
let scrolled = false;
let selectedDateKey = null;
let renderTimeout = null;

// Hitung default shift dari START_DATE untuk hari ini
function calculateDefaultShift() {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const startDate = new Date(START_DATE);
  startDate.setHours(0, 0, 0, 0);
  
  // Hitung selisih hari dari START_DATE ke hari ini
  const diffMs = today.getTime() - startDate.getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  
  // Hitung shift index untuk tiap grup
  const result = {};
  ["A", "B", "C", "D"].forEach(grup => {
    let shiftIndex = (OFFSETS[grup] + diffDays) % 8;
    if (shiftIndex < 0) shiftIndex += 8;
    
    result[grup] = shiftIndex;
  });
  
  console.log("Default shift calculated:", result);
  return result;
}

// Setting awal (dihitung dari START_DATE)
let BASE_SHIFT = JSON.parse(localStorage.getItem("baseShift")) || calculateDefaultShift();

// ===== FUNGSI UTAMA: HITUNG SHIFT =====
function getShiftForDate(grup, targetDate) {
  try {
    // Jika BASE_SHIFT tersimpan di localStorage, gunakan itu sebagai patokan
    // Jika tidak, hitung langsung dari START_DATE
    
    const startDate = new Date(START_DATE);
    startDate.setHours(0, 0, 0, 0);
    
    const target = new Date(targetDate);
    target.setHours(0, 0, 0, 0);
    
    let targetIndex;
    
    if (Object.keys(BASE_SHIFT).length > 0 && localStorage.getItem("baseShift") !== null) {
      // Mode: gunakan BASE_SHIFT sebagai patokan (Custom Shift)
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // Hitung selisih hari antara targetDate dengan hari ini
      const diffMs = target.getTime() - today.getTime();
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      
      // Hitung shift index untuk tanggal target
      targetIndex = (BASE_SHIFT[grup] + diffDays) % 8;
    } else {
      // Mode: hitung langsung dari START_DATE (Default)
      // Hitung selisih hari antara targetDate dengan START_DATE
      const diffMs = target.getTime() - startDate.getTime();
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      
      // Hitung shift index untuk tanggal target
      targetIndex = (OFFSETS[grup] + diffDays) % 8;
    }
    
    if (targetIndex < 0) targetIndex += 8;
    
    // Tentukan apakah "pertama" atau "kedua"
    const shiftType = SHIFT_CYCLE[targetIndex];
    const firstIndex = SHIFT_CYCLE.indexOf(shiftType);
    const isSecond = targetIndex === firstIndex + 1;
    
    return isSecond ? `${shiftType} 2` : `${shiftType} 1`;
  } catch (error) {
    console.error("Error in getShiftForDate:", error);
    return "Error";
  }
}

// ===== THEME FUNCTIONS =====
function initTheme() {
  const savedTheme = localStorage.getItem("shiftTheme") || "default";
  
  // Remove all theme classes
  document.body.classList.remove("theme-lebaran", "theme-natal", "theme-halloween", 
                                "theme-luar-angkasa", "theme-musim-salju", "theme-dark");
  
  // Apply saved theme
  if (savedTheme === "dark") {
    document.body.classList.add("theme-dark");
    document.getElementById("themeSelect").value = "dark";
  } else if (savedTheme !== "default") {
    document.body.classList.add(`theme-${savedTheme}`);
    document.getElementById("themeSelect").value = savedTheme;
  } else {
    document.getElementById("themeSelect").value = "default";
  }
}

function changeTheme(theme) {
  // Remove all theme classes
  document.body.classList.remove("theme-lebaran", "theme-natal", "theme-halloween", 
                                "theme-luar-angkasa", "theme-musim-salju", "theme-dark");
  
  // Apply new theme
  if (theme !== "default") {
    document.body.classList.add(`theme-${theme}`);
  }
  
  // Save to localStorage
  localStorage.setItem("shiftTheme", theme);
  
  // Update select value
  document.getElementById("themeSelect").value = theme;
}

// ===== HELPER FUNCTIONS =====
function dateKey(d) {
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
}

function updateMonthLabel() {
  const monthName = new Date(currentYear, currentMonth).toLocaleDateString("id-ID", { 
    month: "long", 
    year: "numeric" 
  });
  document.getElementById("monthLabel").innerHTML = monthName;
}

function updateTodayDateLabel() {
  const today = new Date();
  const todayFormatted = today.toLocaleDateString("id-ID", {
    weekday: "long",
    day: "numeric",
    month: "long",
    year: "numeric"
  });
  document.getElementById("todayDateLabel").textContent = todayFormatted;
}

// ===== LOADING HOLIDAYS =====
async function loadHolidays(year) {
  const originalText = document.getElementById("monthLabel").textContent;
  document.getElementById("monthLabel").textContent = "Memuat hari libur...";
  
  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 8000);
    
    const r = await fetch(`https://api-harilibur.vercel.app/api?year=${year}`, {
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);
    
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    
    const d = await r.json();
    HOLIDAYS = {};
    d.forEach(i => i.is_national_holiday && (HOLIDAYS[i.holiday_date] = i.holiday_name));
    
  } catch (err) {
    console.log("Gagal memuat hari libur:", err.message);
    HOLIDAYS = {};
  }
  
  updateMonthLabel();
}

// ===== RENDER FUNCTIONS =====
function scheduleRender() {
  if (renderTimeout) clearTimeout(renderTimeout);
  renderTimeout = setTimeout(render, 50);
}

function render() {
  try {
    console.log("Rendering table...");
    const tableBody = document.getElementById("tableBody");
    tableBody.innerHTML = "";
    const todayKey = dateKey(new Date());
    const days = new Date(currentYear, currentMonth + 1, 0).getDate();
    
    for (let d = 1; d <= days; d++) {
      const date = new Date(currentYear, currentMonth, d);
      const key = dateKey(date);
      const tr = document.createElement("tr");
      
      if (key === todayKey) tr.classList.add("today");
      if (key === selectedDateKey) tr.classList.add("selected");
      
      tr.onclick = () => {
        selectedDateKey = (selectedDateKey === key) ? null : key;
        scheduleRender();
      }
      
      const tdDate = document.createElement("td");
      const dayName = date.toLocaleDateString("id-ID", { weekday: "short" });
      const dayNumber = String(date.getDate()).padStart(2, "0");
      tdDate.innerHTML = `<strong>${dayName}, ${dayNumber}</strong>`;
      
      if (HOLIDAYS[key]) {
        tdDate.innerHTML += `<span class="holiday-note">üéâ ${HOLIDAYS[key]}</span>`;
      }
      
      if (date.getDay() === 0) tdDate.classList.add("sunday");
      
      tr.appendChild(tdDate);
      
      ["A", "B", "C", "D"].forEach(grup => {
        const td = document.createElement("td");
        const shift = getShiftForDate(grup, date);
        const shiftType = shift.split(" ")[0].toLowerCase();
        td.innerHTML = `<span class="badge ${shiftType}">${shift}</span>`;
        tr.appendChild(td);
      });
      
      tableBody.appendChild(tr);
      
      if (!scrolled && key === todayKey) {
        setTimeout(() => {
          tr.scrollIntoView({
            behavior: 'smooth',
            block: 'center'
          });
        }, 300);
        scrolled = true;
      }
    }
    console.log("Table rendered successfully");
  } catch (error) {
    console.error("Error in render:", error);
    document.getElementById("tableBody").innerHTML = `<tr><td colspan="5" style="text-align:center;color:red;">Error: ${error.message}</td></tr>`;
  }
}

// ===== EVENT LISTENERS =====
document.getElementById("themeSelect").addEventListener("change", (e) => {
  changeTheme(e.target.value);
});

document.getElementById("darkToggle").addEventListener("click", () => {
  const currentTheme = localStorage.getItem("shiftTheme") || "default";
  if (currentTheme === "dark") {
    changeTheme("default");
  } else {
    changeTheme("dark");
  }
});

// ===== SHIFT MODAL FUNCTIONS =====
function openShiftModal() {
  updateTodayDateLabel();
  
  // Set nilai dropdown sesuai BASE_SHIFT
  document.getElementById("shiftA").value = BASE_SHIFT.A;
  document.getElementById("shiftB").value = BASE_SHIFT.B;
  document.getElementById("shiftC").value = BASE_SHIFT.C;
  document.getElementById("shiftD").value = BASE_SHIFT.D;
  
  document.getElementById("shiftModal").style.display = "flex";
}

function closeShiftModal() {
  document.getElementById("shiftModal").style.display = "none";
}

function resetShiftToDefault() {
  if (confirm("Reset shift ke pengaturan default (berdasarkan 22 Desember 2025)?")) {
    BASE_SHIFT = calculateDefaultShift();
    
    document.getElementById("shiftA").value = BASE_SHIFT.A;
    document.getElementById("shiftB").value = BASE_SHIFT.B;
    document.getElementById("shiftC").value = BASE_SHIFT.C;
    document.getElementById("shiftD").value = BASE_SHIFT.D;
    
    localStorage.removeItem("baseShift");
    scheduleRender();
    
    alert("Shift telah direset ke pengaturan default!");
  }
}

function saveShift() {
  BASE_SHIFT.A = parseInt(document.getElementById("shiftA").value);
  BASE_SHIFT.B = parseInt(document.getElementById("shiftB").value);
  BASE_SHIFT.C = parseInt(document.getElementById("shiftC").value);
  BASE_SHIFT.D = parseInt(document.getElementById("shiftD").value);
  
  localStorage.setItem("baseShift", JSON.stringify(BASE_SHIFT));
  closeShiftModal();
  scheduleRender();
  
  alert("Pengaturan shift berhasil disimpan!");
}

// ===== FULLSCREEN =====
function toggleFullscreen() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen().catch(err => {
      console.log(`Error attempting to enable fullscreen: ${err.message}`);
    });
  } else {
    document.exitFullscreen();
  }
}

document.getElementById("fullscreenToggle").onclick = toggleFullscreen;

// ===== EXPORT PDF =====
function exportToPDF() {
  const monthName = new Date(currentYear, currentMonth).toLocaleDateString('id-ID', {
    month: 'long',
    year: 'numeric'
  });
  
  const currentDate = new Date().toLocaleDateString('id-ID', {
    day: '2-digit',
    month: 'long',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
  
  let tableHTML = '';
  const days = new Date(currentYear, currentMonth + 1, 0).getDate();
  const todayKey = dateKey(new Date());
  
  for (let d = 1; d <= days; d++) {
    const date = new Date(currentYear, currentMonth, d);
    const key = dateKey(date);
    
    const dayName = date.toLocaleDateString('id-ID', { weekday: 'short' }).replace('.', '');
    const dayNum = String(d).padStart(2, '0');
    const dateStr = `${dayName}, ${dayNum}`;
    
    const isSunday = date.getDay() === 0;
    const isToday = key === todayKey;
    const holidayNote = HOLIDAYS[key] ? `<span class="holiday-note">${HOLIDAYS[key]}</span>` : '';
    
    let rowClass = isToday ? 'today' : '';
    
    tableHTML += `<tr${rowClass ? ' class="' + rowClass + '"' : ''}>`;
    tableHTML += `<td class="date-cell${isSunday ? ' sunday' : ''}">${dateStr}${holidayNote}</td>`;
    
    ['A', 'B', 'C', 'D'].forEach(grup => {
      const shift = getShiftForDate(grup, date);
      const shiftType = shift.split(' ')[0].toLowerCase();
      
      tableHTML += `<td class="cell-${shiftType}">${shift}</td>`;
    });
    
    tableHTML += '</tr>';
  }
  
  const printHTML = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Jadwal Shift - ${monthName}</title>
  <style>
    @page { size: A4 portrait; margin: 8mm 10mm; }
    body { font-family: Arial; margin: 0; padding: 0; font-size: 10px; }
    .header { text-align: center; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #333; }
    .main-title { font-size: 16px; font-weight: bold; margin-bottom: 3px; }
    .month-title { font-size: 13px; font-weight: 600; margin-bottom: 3px; }
    .print-date { font-size: 9px; color: #666; }
    table { width: 100%; border-collapse: collapse; font-size: 9px; }
    th { background-color: #f2f2f2; padding: 5px 3px; border: 1px solid #777; text-align: center; }
    td { padding: 4px 3px; border: 1px solid #aaa; text-align: center; }
    .date-cell { width: 65px; text-align: left; padding-left: 6px; font-weight: 600; }
    .cell-pagi { background-color: #fff3cd !important; color: #856404; }
    .cell-sore { background-color: #d1ecf1 !important; color: #0c5460; }
    .cell-malam { background-color: #f8f9fa !important; color: #212529; }
    .cell-libur { background-color: #f8d7da !important; color: #721c24; }
    .sunday { color: #dc3545 !important; }
    .holiday-note { display: block; font-size: 7px; color: #dc3545; font-style: italic; }
    .today td { background-color: rgba(59, 130, 246, 0.1) !important; }
  </style>
</head>
<body>
  <div class="header">
    <div class="main-title">JADWAL KERJA SHIFT</div>
    <div class="month-title">${monthName}</div>
    <div class="print-date">Dicetak: ${currentDate}</div>
  </div>
  
  <table>
    <thead>
      <tr>
        <th style="width: 65px;">Tanggal</th>
        <th>A</th>
        <th>B</th>
        <th>C</th>
        <th>D</th>
      </tr>
    </thead>
    <tbody>
      ${tableHTML}
    </tbody>
  </table>
  
  <div class="footer" style="text-align:center;margin-top:15px;font-size:8px;color:#666;">
    Jadwal Shift ¬© ${new Date().getFullYear()} - Generated by Malfoy ‚òÜ
  </div>
  
  <script>
    window.onload = function() {
      setTimeout(function() {
        window.print();
        setTimeout(function() {
          if (!/Android|iPhone|iPad/.test(navigator.userAgent)) {
            window.close();
          }
        }, 500);
      }, 300);
    };
  <\/script>
</body>
</html>`;
  
  const printWindow = window.open('', '_blank');
  if (!printWindow) {
    alert('Popup diblokir! Izinkan popup untuk mencetak PDF.');
    return;
  }
  
  printWindow.document.open();
  printWindow.document.write(printHTML);
  printWindow.document.close();
}

// ===== MONTH CONTROLS =====
function setMonth(year, month) {
  currentYear = year;
  currentMonth = month;
  document.getElementById("monthPicker").value = `${year}-${String(month + 1).padStart(2, "0")}`;
  scrolled = false;
  
  loadHolidays(year).then(() => {
    scheduleRender();
  });
}

document.getElementById("prev").onclick = () => {
  let y = currentYear, m = currentMonth - 1;
  if (m < 0) { m = 11; y--; }
  setMonth(y, m);
};

document.getElementById("next").onclick = () => {
  let y = currentYear, m = currentMonth + 1;
  if (m > 11) { m = 0; y++; }
  setMonth(y, m);
};

document.getElementById("monthPicker").onchange = e => {
  const [y, m] = e.target.value.split("-");
  setMonth(+y, +m - 1);
};

// ===== START APPLICATION =====
const now = new Date();
setMonth(now.getFullYear(), now.getMonth());
initTheme();

document.getElementById("shiftModal").addEventListener("click", function (e) {
  if (e.target === this) closeShiftModal();
});

// Debug info
console.log("===== DEBUG INFO =====");
console.log("START_DATE:", START_DATE.toLocaleDateString());
console.log("BASE_SHIFT:", BASE_SHIFT);

const testDate = new Date(2026, 0, 8); // 8 Januari 2026
console.log("Tanggal 8 Januari 2026:");
["A", "B", "C", "D"].forEach(grup => {
  const shift = getShiftForDate(grup, testDate);
  console.log(`Grup ${grup}: ${shift}`);
});
</script>
</body>
</html>
